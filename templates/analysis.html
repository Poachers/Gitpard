{% extends "main.html" %}
{% load staticfiles %}

{% block content %}
    <div class="container" ng-controller="analysis">
        <div class="row">
            <div class="col-lg-4 col-md-5 col-sm-7 col-xs-10 col-lg-offset-1 col-md-offset-1 col-sm-offset-1
                    col-xs-offset-0">
                <div class="row">
                    <div class="col-sm-11 col-lg-11 col-md-11">
                        <h4 class="text-primary">Gitpard</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 col-lg-3 col-sm-3 col-xs-3">
                        <h4>Ветка :</h4></div>
                    <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 pull-left">
                        <select
                                class="form-control" ng-change="changeBranch()"
                                ng-model="branch" ng-options="branch.name for branch in branches">
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-3 col-lg-3 col-sm-12 col-xs-12 dirs">
                <div id="tree"></div>
            </div>
            <div class="col-md-9 col-lg-9 col-sm-12 col-xs-12">
                <p>
                    <strong>. /<span class="text-primary"> manage.py</span></strong>
                </p>

                <div class="col-md-12 col-lg-12 col-sm-12 col-xs-12 ">
                    <div class="row line_header navbar-default">
                        <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1"><strong>#</strong></div>
                        <div class="col-lg-5 col-md-5 col-sm-11 col-xs-11"><strong>Строка</strong></div>
                        <div class="col-lg-2 col-md-2 hidden-sm hidden-xs"><strong>Автор</strong></div>
                        <div class="col-lg-2 col-md-2 hidden-sm hidden-xs"><strong>Дата создания</strong></div>
                        <div class="col-lg-2 col-md-2 hidden-sm hidden-xs"><strong>Коммит</strong></div>
                    </div>
                    <div class="table">
                        {% for i in file %}
                            <div class="row line-table visible-lg visible-md">
                                <div class="col-md-1 col-lg-1">{{ i.num }}</div>
                                <div class="col-lg-5 col-md-5">
                                    {{ i.title }}
                                </div>
                                <div class="col-lg-2 col-md-2">{{ i.a }}</div>
                                <div class="col-lg-2 col-md-2">{{ i.date }}</div>
                                <div class="col-lg-2 col-md-2">{{ i.com }}</div>
                            </div>
                            <div class="row line-table visible-sm visible-xs">
                                <div class="col-sm-1 col-xs-2" data-toggle="collapse"
                                     data-target="#line_{{ i.num }}">{{ i.num }}</div>
                                <div class="col-sm-11 col-xs-10" data-toggle="collapse" data-target="#line_{{ i.num }}">
                                    {{ i.title }}
                                </div>
                                <div class="col-sm-11 col-sm-offset-1 col-xs-11 col-xs-offset-1">
                                    <div class="collapse" id="line_{{ i.num }}">
                                        <div class="col-sm-3 col-xs-3"><strong>Автор :</strong></div>
                                        <div class="col-sm-9 col-xs-9">{{ i.a }}</div>
                                        <div class="col-sm-3 col-xs-6"><strong>Дата Создания :</strong></div>
                                        <div class="col-sm-9 col-xs-6">{{ i.date }}</div>
                                        <div class="col-sm-3 col-xs-4 "><strong>Коммит :</strong></div>
                                        <div class="col-sm-9 col-xs-8 ">{{ i.com }}</div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% static 'bootstrap/bootstrap-treeview.min.js' %}"></script>
    <script src="{% static 'bootstrap/bootstrap-treeview.min.css' %}"></script>
    <script>
        gitpard = angular.module('gitpard');

        gitpard
                .controller('analysis', ['$scope', '$API', function ($scope, API) {

                    function getTree() {
                        API.repoTree({
                            id: location.hash.replace('#', ''),
                            branch: $scope.branch.name
                        }, function (data) {
                            //Документация https://github.com/jonmiles/bootstrap-treeview
                            $('#tree').treeview({
                                data: data.project,
                                showBorder: false,
                                emptyIcon: "glyphicon glyphicon-file",
                                expandIcon: 'glyphicon glyphicon-folder-close',
                                collapseIcon: 'glyphicon glyphicon-folder-open',
                                levels: 0
                            });
                        });
                    }


                    API.repoBranches/*repoAnalysis*/(location.hash.replace('#', ''), function (data) {
                        $scope.branches = [];
                        var temp = data.branches,
                                i;
                        for (i in temp) {
                            $scope.branches[(temp[i].branch_name == 'master' ? 'unshift' : 'push')]({name: temp[i].branch_name});
                        }
                        $scope.branch = $scope.branches[0];
                        getTree();
                    });

                    $scope.changeBranch = function () {
                        getTree();
                    };
                }]);
        location.hash.replace('#', '');
    </script>
{% endblock scripts %}