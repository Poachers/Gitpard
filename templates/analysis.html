{% extends "main.html" %}
{% load staticfiles %}

{% block content %}
    <script src="{% static 'js/jquery.jscrollpane.min.js' %}"></script>
    <div class="container" ng-controller="analysis" xmlns="http://www.w3.org/1999/html">
        <div class="row">
            <div class="col-lg-4 col-md-5 col-sm-7 col-xs-10 col-lg-offset-1 col-md-offset-1 col-sm-offset-1
                    col-xs-offset-0">
                <div class="row">
                    <div class="col-sm-11 col-lg-11 col-md-11">
                        <h4 class="text-primary">Gitpard</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 col-lg-3 col-sm-3 col-xs-3">
                        <h4>Ветка :</h4></div>
                    <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 pull-left">
                        <select
                                class="form-control" ng-change="changeBranch()"
                                ng-model="branch" ng-options="branch.name for branch in branches">
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div id="loading" ng-if="!loading"></div>
        <div class="row">
            <div class="col-md-3 col-lg-3 col-sm-12 col-xs-12 div_dirs">
                <div class="dirs">
                    <div id="tree"></div>
                </div>
            </div>
            <div class="col-md-9 col-lg-9 col-sm-12 col-xs-12">
                <span ng-if="lines == undefined" class="text-center">
                    <h2>Файл не выбран</h2>
                </span>

                <span ng-if="lines != undefined">
                <p>
                    <strong>{$ path $}</strong>
                </p>

                <span ng-if="lines.length">
                    <div class="col-md-12 col-lg-12 col-sm-12 col-xs-12 ">
                        <div class="row line line_header navbar-default">
                            <div class="col-lg-1 col-md-1 col-sm-1 col-xs-2"><strong>#</strong></div>
                            <div class="col-lg-5 col-md-5 col-sm-11 col-xs-10 title_head"><strong>Строка</strong>

                                <div class="scroll_title hidden-sm hidden-xs">
                                    <div class="fake"></div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-2 hidden-sm hidden-xs"><strong>Автор</strong></div>
                            <div class="col-lg-2 col-md-2 hidden-sm hidden-xs"><strong>Дата создания</strong></div>
                            <div class="col-lg-2 col-md-2 hidden-sm hidden-xs title_com_head"><strong>Коммит</strong>

                                <div class="scroll_com">
                                    <div class="fake2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row line table visible-lg visible-md">
                            <div class="num col-lg-1 col-md-1">
                                <div class="row line" ng-repeat="line in lines">{$ line.number $}</div>
                            </div>
                            <div class="col-lg-5 col-md-5 title">
                                <div class="row line" ng-repeat="line in lines">
                                    <div class="title_line">{$ repLine(line.line) $}</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-2">
                                <div class="row line" ng-repeat="line in lines">{$ line.author $}</div>
                            </div>
                            <div class="col-lg-2 col-md-2">
                                <div class="row line" ng-repeat="line in lines"
                                     title="{$ line.created_date | date: 'HH:mm:ss' $}">{$ line.created_date |
                                    date:"dd/MM/yyyy" $}
                                </div>
                            </div>

                            <div class="col-lg-2 col-md-2 com">
                                <div class="row line" ng-repeat="line in lines">
                                    <div class="com_line">{$ line.commit $}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row line table visible-sm visible-xs">
                            <div class="col-sm-1 col-xs-2">
                                <div class="row line" data-toggle="collapse" ng-repeat="line in lines"
                                     data-target="#line_{$ line.number $}">{$ line.number $}
                                </div>
                            </div>
                            <div class="col-sm-11 col-xs-10">
                                <span ng-repeat="line in lines">
                                    <div class="row line title_line title_line_min" data-toggle="collapse"
                                         data-target="#line_{$ line.number $}">
                                        {$ line.line $}
                                    </div>
                                    <div class="row line">
                                        <div class="col-sm-12 col-xs-12 collapse" id="line_{$ line.number $}">
                                            <div class="col-sm-4 col-xs-4 text-right"><strong>Автор :</strong></div>
                                            <div class="col-sm-8 col-xs-8">{$ line.author $}</div>
                                            <div class="col-sm-4 hidden-xs text-right"><strong>Дата Создания :</strong>
                                            </div>
                                            <div class="col-xs-4 hidden-sm text-right"><strong>Дата:</strong></div>
                                            <div class="col-sm-8 col-xs-8">{$ line.created_date | date: 'dd/MM/yyyy
                                                HH:mm:ss' $}
                                            </div>
                                            <div class="col-sm-4 col-xs-4 text-right"><strong>Коммит :</strong></div>
                                            <div class="col-sm-8 col-xs-5 com_min">{$ line.commit $}</div>
                                        </div>
                                    </div>
                                </span>
                            </div>
                        </div>
                    </div>
                </span>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% static 'bootstrap/bootstrap-treeview.min.js' %}"></script>
    <script src="{% static 'bootstrap/bootstrap-treeview.min.css' %}"></script>
    <script>
        var scroll_title = $('.scroll_title');
        var title = $('.title');
        var scroll_com = $('.scroll_com');
        var com = $('.com');
        $('.fake').width($('.max_title').width() + 20);
        $('.fake2').width($('.max_com').width() + 20);
        scroll_title.scroll(function (e) {
            title.scrollLeft($(this).scrollLeft());
        });
        title.scroll(function (e) {
            scroll_title.scrollLeft($(this).scrollLeft());
        });


        scroll_com.scroll(function (e) {
            com.scrollLeft($(this).scrollLeft());
        });
        com.scroll(function (e) {
            scroll_com.scrollLeft($(this).scrollLeft());
        });


        gitpard = angular.module('gitpard');

        gitpard
                .controller('analysis', ['$scope', '$API', function ($scope, API) {

                    function getUrl(data) {
                        var url = '';

                        if (data.parentId != undefined) {
                            url = getUrl($('#tree').treeview('getNode', data.parentId));
                        }


                        return url + '/' + data.text;
                    }

                    $scope.repLine = function (line) {
                        return line.replace(/\s/g, '  ');
                    };

                    function getTree() {
                        $scope.lines = undefined;
                        $scope.path = '';
                        $scope.loading = true;

                        API.repoTree({
                            id: location.hash.replace('#', ''),
                            branch: $scope.branch.name
                        }, function (data) {
                            //Документация https://github.com/jonmiles/bootstrap-treeview
                            $('#tree').treeview({
                                data: data.project,
                                showBorder: false,
                                emptyIcon: "glyphicon glyphicon-file",
                                expandIcon: 'glyphicon glyphicon-folder-close',
                                collapseIcon: 'glyphicon glyphicon-folder-open',
                                levels: 0,
                                onNodeSelected: function (event, data) {
                                    $scope.path = getUrl(data);
                                    API.getFile({
                                        file: getUrl(data),
                                        id: location.hash.replace('#', ''),
                                        branch: $scope.branch.name
                                    }, function (data) {
                                        $scope.lines = data.data;
                                    });
                                }
                            });
                        });
                    }


                    API.repoBranches/*repoAnalysis*/(location.hash.replace('#', ''), function (data) {
                        $scope.branches = [];
                        var temp = data.branches,
                                i;
                        for (i in temp) {
                            $scope.branches[(temp[i].branch_name == 'master' ? 'unshift' : 'push')]({name: temp[i].branch_name});
                        }
                        $scope.branch = $scope.branches[0];
                        getTree();
                    });

                    $scope.changeBranch = function () {
                        getTree();
                    };
                }]);
    </script>
{% endblock scripts %}